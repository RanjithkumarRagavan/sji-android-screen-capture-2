/*
 Let json file support "//comment..." style comment.

 [Usage]
 var jsonFile = require('./common/jsonFile.js');
 var json = jsonFile.parse('file.json');
 the result "json" will be null when failed to read or parse file.
 jsonFile.getLastError() will indicate error message.
 */
'use strict';
var fs = require('fs');

var lastError = '';

function parse(filePath) {
  var buf;
  try {
    buf = fs.readFileSync(filePath);
  }
  catch (e) {
    lastError = 'failed to open JSON file. ' + e;
    return null;
  }

  //empty file is ok
  if (buf.length === 0) {
    return {};
  }

  var s = buf.toString();

  //remove //comment...  style comment (only from head)
  s = s.replace(/^[ \t]*\/\/.*$/gm, '');
  s = s.trim();

  //empty file is ok
  if (s.length === 0) {
    return {};
  }

  try {
    return JSON.parse(s);
  }
  catch (e) {
    lastError = 'failed to parse JSON file. ' + e;
    return null;
  }
}

function getLastError() {
  return lastError;
}

exports.parse = parse;
exports.getLastError = getLastError;